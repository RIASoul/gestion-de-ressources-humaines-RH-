<div class="dashboard-container">
  <div class="dashboard-header">
    <div>
      <h1>Tableau de bord RH</h1>
      <p>Suivez les indicateurs clés issus des microservices employés, congés et paie.</p>
    </div>
    <button mat-raised-button color="primary" type="button">
      <mat-icon>file_download</mat-icon>
      Exporter le rapport
    </button>
  </div>

  <ng-container *ngIf="viewModel$ | async as vm; else loading">
    <section class="stats-grid">
      <mat-card
        class="stat-card"
        *ngFor="let card of vm.cards"
        [ngClass]="['tone-' + card.tone]"
      >
        <div class="stat-icon">
          <mat-icon>{{ card.icon }}</mat-icon>
        </div>
        <div class="stat-content">
          <p class="stat-label">{{ card.label }}</p>
          <p class="stat-value">{{ card.value }}</p>
          <span class="stat-helper" *ngIf="card.helper">{{ card.helper }}</span>
        </div>
      </mat-card>
    </section>

    <section class="content-grid">
      <mat-card class="panel-card">
        <div class="card-header">
          <div>
            <h2>Congés en attente</h2>
            <p>Demandes à valider par les managers</p>
          </div>
          <button mat-stroked-button color="primary" routerLink="/admin/conges">Gérer</button>
        </div>
        <mat-divider></mat-divider>
        <mat-list *ngIf="vm.pendingLeaves.length; else noPending">
          <mat-list-item *ngFor="let conge of vm.pendingLeaves">
            <div matListItemTitle>{{ conge.employeeNom }}</div>
            <div matListItemLine>
              {{ conge.typeConge }} • {{ conge.nombreJours }} jours
            </div>
            <div matListItemMeta>
              {{ conge.dateDebut | date: 'dd MMM' }} → {{ conge.dateFin | date: 'dd MMM yyyy' }}
            </div>
          </mat-list-item>
        </mat-list>
        <ng-template #noPending>
          <div class="empty-state">
            <mat-icon>sentiment_satisfied</mat-icon>
            <p>Aucune demande de congé en attente</p>
          </div>
        </ng-template>
      </mat-card>

      <mat-card class="panel-card">
        <div class="card-header">
          <div>
            <h2>Top départements</h2>
            <p>Répartition des collaborateurs</p>
          </div>
        </div>
        <mat-divider></mat-divider>
        <table class="departments-table" *ngIf="vm.departments.length; else noDepartment">
          <thead>
            <tr>
              <th>Département</th>
              <th>Effectif</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let department of vm.departments; index as index">
              <td>
                <span class="rank">#{{ index + 1 }}</span>
                {{ department.departmentName }}
              </td>
              <td>{{ department.employeeCount }}</td>
            </tr>
          </tbody>
        </table>
        <ng-template #noDepartment>
          <div class="empty-state">
            <mat-icon>insights</mat-icon>
            <p>Aucune donnée de département disponible</p>
          </div>
        </ng-template>
      </mat-card>

      <mat-card class="panel-card activity-card">
        <div class="card-header">
          <div>
            <h2>Derniers mouvements</h2>
            <p>Historique des dernières demandes de congé</p>
          </div>
          <button mat-button color="primary" routerLink="/admin/conges">Voir tout</button>
        </div>
        <mat-divider></mat-divider>
        <mat-list *ngIf="vm.latestLeaves.length; else noHistory">
          <mat-list-item *ngFor="let conge of vm.latestLeaves">
            <div matListItemTitle>{{ conge.employeeNom }}</div>
            <div matListItemLine>
              {{ conge.typeConge }} •
              <mat-chip-set aria-label="Statut de congé">
              <mat-chip [color]="conge.statut === 'APPROUVE' ? 'primary' : conge.statut === 'REFUSE' ? 'warn' : undefined">
                  {{ conge.statut | titlecase }}
                </mat-chip>
              </mat-chip-set>
            </div>
            <div matListItemMeta>{{ conge.createdAt | date: 'dd MMM yyyy, HH:mm' }}</div>
          </mat-list-item>
        </mat-list>
        <ng-template #noHistory>
          <div class="empty-state">
            <mat-icon>history</mat-icon>
            <p>Aucune activité récente</p>
          </div>
        </ng-template>
      </mat-card>
    </section>
  </ng-container>

  <ng-template #loading>
    <div class="loading-state">
      <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
      <p>Chargement des indicateurs...</p>
    </div>
  </ng-template>

  <div class="error-banner" *ngIf="error()">
    <mat-icon>error_outline</mat-icon>
    {{ error() }}
  </div>
</div>
